{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1>Dashboard Cooperativa</h1>
<p>Bem-vindo, {{ request.user.get_username }}.</p>

<div style="display:grid;grid-template-columns:320px 1fr;gap:20px;align-items:flex-start;max-width:1200px;">
  <!-- CARTÃO DO USUÁRIO -->
  <section style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;">
    <h3 style="margin-top:0;">Seu perfil</h3>
    <div style="display:flex;gap:14px;align-items:center;">
      {% if request.user.profile.foto %}
        <img id="user-photo"
             src="{{ request.user.profile.foto.url }}"
             alt="Foto do usuário"
             style="width:96px;height:96px;border-radius:50%;object-fit:cover;border:1px solid #ddd;">
      {% else %}
       <img id="user-photo"
            src="{% static 'img/user_placeholder.png' %}"
            alt="Foto padrão"
            style="width:96px;height:96px;border-radius:50%;object-fit:cover;border:1px solid #ddd;">
      {% endif %}

      <div>
        <div style="font-weight:600;">{{ request.user.get_full_name|default:request.user.get_username }}</div>
        <small style="opacity:.7;">Logado</small>
      </div>
    </div>
    <p style="margin:10px 0 0;"><small>Dica: se tiver <code>profile.foto</code> no usuário, a imagem troca automaticamente.</small></p>
  </section>

  <!-- CALENDÁRIO -->
  <section style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <button id="prev-month" type="button" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#f8fafc;">◀</button>
      <h3 id="cal-title" style="margin:0;">Calendário</h3>
      <button id="next-month" type="button" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#f8fafc;">▶</button>
    </div>

    <div id="calendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;"></div>

    <div style="display:flex;gap:14px;margin-top:12px;align-items:center;flex-wrap:wrap;">
      <span style="display:inline-flex;align-items:center;gap:6px;">
        <span style="width:14px;height:14px;background:#fff7cc;border:1px solid #e6d784;border-radius:3px;display:inline-block;"></span>
        Nota (dia marcado)
      </span>
      <span style="display:inline-flex;align-items:center;gap:6px;">
        <span style="width:14px;height:14px;background:#ffe4e6;border:1px solid #f5c2c7;border-radius:3px;display:inline-block;"></span>
        Feriado nacional
      </span>
      <small style="opacity:.7;">Clique em um dia para adicionar/editar uma nota. Apague a nota deixando o campo vazio.</small>
    </div>
  </section>
</div>

<script>
(function(){
  const img = document.getElementById('user-photo');
  const dyn = img?.dataset.dynamicSrc;
  if (dyn) img.src = dyn;
})();

(function(){
  const elCal   = document.getElementById('calendar');
  const elTitle = document.getElementById('cal-title');
  const prevBtn = document.getElementById('prev-month');
  const nextBtn = document.getElementById('next-month');

  const MESES = ["janeiro","fevereiro","março","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
  const DIAS  = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
  const USER_ID = "{{ request.user.id|default:'anon' }}";
  const STORAGE_KEY = "cal-notes-" + USER_ID;

  function toISO(d){ return d.toISOString().slice(0,10); }
  function ymd(y,m,d){ return new Date(y, m, d, 12); }
  function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }

  function easterDate(year){
    const a=year%19, b=Math.floor(year/100), c=year%100, d=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25),
      g=Math.floor((b-f+1)/3), h=(19*a+b-d-g+15)%30, i=Math.floor(c/4), k=c%4,
      l=(32+2*e+2*i-h-k)%7, m=Math.floor((a+11*h+22*l)/451),
      month=Math.floor((h+l-7*m+114)/31)-1,
      day=((h+l-7*m+114)%31)+1;
    return ymd(year, month, day);
  }

  function brHolidays(year){
    const easter = easterDate(year);
    const goodFriday = addDays(easter,-2);
    const fixed = [
      { d: ymd(year,0,1),   n: "Confraternização Universal" },
      { d: goodFriday,      n: "Sexta-Feira Santa" },
      { d: ymd(year,3,21),  n: "Tiradentes" },
      { d: ymd(year,4,1),   n: "Dia do Trabalhador" },
      { d: ymd(year,8,7),   n: "Independência do Brasil" },
      { d: ymd(year,9,12),  n: "Nossa Senhora Aparecida" },
      { d: ymd(year,10,2),  n: "Finados" },
      { d: ymd(year,10,15), n: "Proclamação da República" },
      { d: ymd(year,11,25), n: "Natal" },
    ];
    const map = {};
    fixed.forEach(h => map[toISO(h.d)] = h.n);
    return map;
  }

  function loadNotes(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch { return {}; } }
  function saveNotes(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

  let shown = (function(){ const d = new Date(); return { y:d.getFullYear(), m:d.getMonth() }; })();
  let notes = loadNotes();

  function render(){
    const {y,m} = shown;
    const fer = brHolidays(y);
    elCal.innerHTML = "";

    DIAS.forEach(w => {
      const h = document.createElement("div");
      h.textContent = w;
      h.style.cssText = "text-align:center;font-weight:600;opacity:.8;padding:6px 0;";
      elCal.appendChild(h);
    });

    const first = new Date(y, m, 1);
    const startCol = (first.getDay() + 7) % 7;
    const daysInMonth = new Date(y, m+1, 0).getDate();

    for (let i=0;i<startCol;i++){
      const e = document.createElement("div");
      e.style.minHeight = "68px";
      elCal.appendChild(e);
    }

    for (let d=1; d<=daysInMonth; d++){
      const date = ymd(y,m,d);
      const iso = toISO(date);
      const cell = document.createElement("button");
      cell.type = "button";
      cell.style.cssText = "text-align:left;min-height:68px;padding:6px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;position:relative;";
      cell.setAttribute("data-date", iso);

      const num = document.createElement("div");
      num.textContent = d;
      num.style.cssText = "font-weight:700;margin-bottom:4px;opacity:.9;";
      cell.appendChild(num);

      if (fer[iso]){
        cell.style.background = "#ffe4e6";
        cell.style.borderColor = "#f5c2c7";
        const tag = document.createElement("div");
        tag.textContent = fer[iso];
        tag.title = fer[iso];
        tag.style.cssText = "font-size:.8em;opacity:.9;";
        cell.appendChild(tag);
      }

      if (notes[iso]){
        cell.style.background = "#fff7cc";
        cell.style.borderColor = "#e6d784";
        const nt = document.createElement("div");
	nt.textContent = notes[iso];
        nt.style.cssText = "font-size:.82em;margin-top:2px;white-	space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;";
        cell.appendChild(nt);
      }

      cell.addEventListener("click", () => {
        const atual = notes[iso] || "";
        const novo = prompt(`Nota para ${d}/${(m+1).toString().padStart(2,"0")}/${y}:`, atual);
        if (novo === null) return;
        if (novo.trim() === ""){
          delete notes[iso];
        } else {
          notes[iso] = novo.trim();
        }
        saveNotes(notes);
        render();
      });

      elCal.appendChild(cell);
    }

    elTitle.textContent = `${MESES[m]} de ${y}`;
  }

  prevBtn.addEventListener("click", () => {
    if (shown.m === 0) { shown.m = 11; shown.y--; } else { shown.m--; }
    render();
  });

  nextBtn.addEventListener("click", () => {
    if (shown.m === 11) { shown.m = 0; shown.y++; } else { shown.m++; }
    render();
  });

  render();
})();
</script>
{% endblock %}

